<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Entry</title>
<link rel="stylesheet" href="style.css">

<script type="module" src="../config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="main-content">
    <div class="container">
        <div class="page-header">
            <h1>Data Entry</h1>
        </div>

        <div id="loader"></div>

        <div class="card">
            <div class="form-group">
                <select id="channelSelect">
                    <option value="">Select Channel</option>
                </select>
            </div>

            <div id="inputDiv" style="display:none;">
                <div class="form-group">
                    <input id="conversion" type="text" placeholder="Enter Conversion">
                </div>
                <div class="form-group">
                    <input id="clicks" type="text" placeholder="Enter Clicks">
                </div>
                <div class="form-group">
                    <select id="appSelect">
                        <option value="">Select App</option>
                    </select>
                </div>
                <div class="form-group">
                    <input id="revenue" type="text" disabled placeholder="Revenue">
                </div>
                <button id="addBtn">Add Data</button>
            </div>
        </div>

        <div id="dataTableSection" style="display:none;margin-top:30px;">
            <h2 style="font-size:20px;margin-bottom:20px;">Channel Data Records</h2>
            <table>
                <thead>
                    <tr>
                        <th>App Name</th>
                        <th>Clicks</th>
                        <th>Conversion</th>
                        <th>Revenue</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script type="module">
import { db } from "../config.js"
import { collection, getDocs, addDoc, doc, getDoc, updateDoc, deleteDoc, serverTimestamp, query, where } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js"

const loader = document.getElementById("loader")
const channelSelect = document.getElementById("channelSelect")
const appSelect = document.getElementById("appSelect")
const revenueInput = document.getElementById("revenue")
const conversionInput = document.getElementById("conversion")
const inputDiv = document.getElementById("inputDiv")
const dataTableSection = document.getElementById("dataTableSection")
const dataTableBody = document.getElementById("dataTableBody")

let selectedRevenueRate = 0
let allApps = {}

async function creditDaily(){
    const today = new Date().toISOString().split("T")[0]
    const snap = await getDocs(collection(db,"data"))
    for(const d of snap.docs){
        const x = d.data()
        if(!x.credit_tomorrow) continue
        if(x.credited) continue
        const ts = new Date(x.timestamp.seconds * 1000)
        const dataDate = ts.toISOString().split("T")[0]
        if(dataDate === today) continue
        const ref = doc(db,"channel",x.channel_id)
        const c = await getDoc(ref)
        const bal = Number(c.data().balance || 0)
        await updateDoc(ref,{ balance: bal + Number(x.revenue) })
        await updateDoc(doc(db,"data",d.id),{ credited:true })
    }
}

async function loadChannels(){
    loader.style.display = "block"
    const snap = await getDocs(collection(db,"channel"))
    snap.forEach(d=>{
        const x = d.data()
        const op = document.createElement("option")
        op.value = d.id
        op.textContent = x.name
        channelSelect.appendChild(op)
    })
    loader.style.display = "none"
}

async function loadApps(){
    loader.style.display = "block"
    const snap = await getDocs(collection(db,"apps"))
    snap.forEach(d=>{
        const x = d.data()
        allApps[d.id] = x.title
        const op = document.createElement("option")
        op.value = d.id
        op.textContent = x.title
        op.dataset.revenue = x.revenue
        appSelect.appendChild(op)
    })
    loader.style.display = "none"
}

async function loadChannelData(channelID){
    loader.style.display = "block"
    dataTableBody.innerHTML = ""
    
    const snap = await getDocs(collection(db,"data"))
    let hasData = false
    
    snap.forEach(d => {
        const x = d.data()
        if(x.channel_id !== channelID) return
        
        hasData = true
        const tr = document.createElement("tr")
        
        const ts = x.timestamp ? new Date(x.timestamp.seconds * 1000) : null
        const dateStr = ts ? ts.toISOString().split("T")[0] : "N/A"
        
        const statusText = x.credited ? "Credited" : "Pending"
        const statusClass = x.credited ? "btn-success" : "btn-secondary"
        
        tr.innerHTML = `
            <td>${allApps[x.app_id] || "N/A"}</td>
            <td>${x.click}</td>
            <td>${x.conversion}</td>
            <td>â‚¹${x.revenue}</td>
            <td><button class="${statusClass}" style="padding:6px 12px;font-size:12px;cursor:default">${statusText}</button></td>
            <td>${dateStr}</td>
            <td><button class="btn-danger deleteBtn" data-id="${d.id}">Delete</button></td>
        `
        
        dataTableBody.appendChild(tr)
    })
    
    dataTableSection.style.display = hasData ? "block" : "none"
    
    document.querySelectorAll(".deleteBtn").forEach(btn => {
        btn.onclick = async () => {
            const result = await Swal.fire({
                title: 'Delete Record?',
                text: 'This action cannot be undone',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, Delete',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#f44336'
            })
            
            if(result.isConfirmed){
                loader.style.display = "block"
                await deleteDoc(doc(db, "data", btn.dataset.id))
                Swal.fire({
                    icon: 'success',
                    title: 'Deleted',
                    timer: 1500,
                    showConfirmButton: false
                })
                loadChannelData(channelSelect.value)
            }
        }
    })
    
    loader.style.display = "none"
}

function calculateRevenue(){
    const conv = Number(conversionInput.value) || 0
    revenueInput.value = conv * selectedRevenueRate
}

channelSelect.onchange = () => {
    const channelID = channelSelect.value
    inputDiv.style.display = channelID ? "block" : "none"
    if(channelID){
        loadChannelData(channelID)
    } else {
        dataTableSection.style.display = "none"
    }
}

appSelect.onchange = () => {
    const sel = appSelect.options[appSelect.selectedIndex]
    selectedRevenueRate = Number(sel.dataset.revenue || 0)
    calculateRevenue()
}

conversionInput.oninput = () => calculateRevenue()

document.getElementById("addBtn").onclick = async () => {
    const channelID = channelSelect.value
    const appID = appSelect.value
    const conversion = conversionInput.value
    const clicks = document.getElementById("clicks").value
    const revenue = Number(revenueInput.value)

    if(!channelID || !appID || !conversion || !clicks){
        Swal.fire("Fill all fields")
        return
    }

    loader.style.display = "block"

    await addDoc(collection(db,"data"),{
        channel_id: channelID,
        app_id: appID,
        conversion: conversion,
        click: clicks,
        revenue: revenue,
        credit_tomorrow: true,
        credited: false,
        timestamp: serverTimestamp()
    })

    loader.style.display = "none"
    Swal.fire("Saved<br>Wallet will update tomorrow after 12 AM")

    conversionInput.value = ""
    document.getElementById("clicks").value = ""
    appSelect.value = ""
    revenueInput.value = ""
    
    loadChannelData(channelID)
}

creditDaily()
loadChannels()
loadApps()
</script>

<script src="auth.js"></script>
<script src="sidebar.js"></script>
